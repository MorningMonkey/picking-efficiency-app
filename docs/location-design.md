# Location（棚番 / ロケーション）設計書（Draft）

本ドキュメントでは、商品の保管場所を表す **ロケーション（棚番）** の命名規則・データ構造・運用ルールを定義する。  
ロケーション情報は、ピッキングリスト生成、棚順ソート（ルート最適化）、倉庫運用の大部分に影響するため、  
**柔軟性・拡張性・運用しやすさ** を重視した構成とする。　

---

# 1. ロケーション管理の目的

- 倉庫ごとに異なる棚番ルールをアプリ側で吸収し統一管理する  
- ピッキングリストを **棚順ソート** するための基盤を作る  
- 商品（Product）と棚（Location）を安定的に紐づける  
- 倉庫のレイアウト変更にも対応しやすい設計とする  

---

# 2. ロケーション構造の基本方針

ロケーション情報は **「表示」** と **「ソート（ルート順）」** を分離して管理する。

| 項目                              | 説明                                               |
| --------------------------------- | -------------------------------------------------- |
| display_code                      | 人間が見る棚番。例：A-01-05                        |
| sort_order                        | ピッキングリスト作成時に使用するソートキー（数値） |
| zone / aisle / rack / level / bin | 倉庫内の階層情報（必要な場合のみ使用）             |

表示とソートを分離する理由：

- 表示は倉庫ごとに独自ルール（A-01-05、1-2-3 など）
- ソートは倉庫内の実際の動線に合わせて柔軟に変更したい

**表示を変えても、ソート順（=動線）が壊れない** ようにするのがポイント。

---

# 3. ロケーションのデータモデル（初期案）

Django モデルとして想定するフィールド：

| フィールド名 | 型             | 必須 | 説明                                                          |
| ------------ | -------------- | ---- | ------------------------------------------------------------- |
| code         | string         | 必須 | location_code（CSVで流れてくる棚番コード）                    |
| display_name | string         | 必須 | 画面に表示する棚番（code と同じでOK。将来フォーマット切替可） |
| zone         | string         | 任意 | エリア（A/B/C、冷蔵/常温）                                    |
| aisle        | integer        | 任意 | 通路番号                                                      |
| rack         | integer        | 任意 | 棚番号                                                        |
| level        | integer        | 任意 | 段（上段/下段）                                               |
| bin          | integer/string | 任意 | 枠/区画                                                       |
| sort_order   | integer        | 必須 | ピッキング時の棚順ソートに使用                                |
| is_active    | boolean        | 必須 | 使用中かどうか（削除の代わりに無効化運用）                    |
| updated_at   | datetime       | 自動 | 更新日時                                                      |
| created_at   | datetime       | 自動 | 作成日時                                                      |

### 最小構成は以下の3つで成立：

- `code`（棚番コード）
- `display_name`
- `sort_order`

倉庫が小規模で zone/aisle/rack/level/bin を使わなければ **使用しないフィールドは空でOK**。

---

# 4. 棚番コード（display_code / code）の命名パターン例

倉庫によって棚番表示のルールは異なるため、以下の代表的なパターンをサポートする。

---

## 4-1. パターンA（3階層：エリア - 棚 - 段）

例：  
A-01-05
A = エリア
01 = 棚
05 = 段


倉庫で最も一般的。視認性が高く、関係者に理解しやすい。

---

## 4-2. パターンB（通路 - 棚 - 段 - 枠の4階層）

例：  
A1-02-03-04
A1 = 通路
02 = 棚
03 = 段
04 = 枠

大型倉庫で枠（Bin）が細かく分かれている場合に便利。

---

## 4-3. パターンC（ゾーン＋階層の自由組み合わせ）【推奨】

DB には zone/aisle/rack/level/bin を個別に保存し、  
`display_code` はテンプレートで生成可能にする。

例：  
"{zone}-{aisle:02}-{rack:02}-{level}"

→ 倉庫ごとにルールが違ってもテンプレートで対応できる。


→ 倉庫ごとにルールが違ってもテンプレートで対応できる。

---

# 5. ソート順（sort_order）の設計

ピッキングリストのルート案内で最も重要な項目。

### 基本方針：
- **code（棚番）ではソートしない**  
- **sort_order（整数）でソートする**

### 理由：
棚番コードの文字列ソートは危険  
（例：`A-1-10` が `A-1-2` より先に並んでしまう）

### 運用例：

| display_code | sort_order |
| ------------ | ---------- |
| A-01-01      | 10         |
| A-01-02      | 20         |
| A-02-01      | 30         |
| B-01-01      | 40         |

### 倉庫の棚順が変わっても：

- display_code → **変更されてもOK**  
- sort_order → **並び順だけ変更すれば動線が変わる**

これにより倉庫配置換えにも柔軟に対応できる。

---

# 6. Location と Product の関係

CSV インポート時：

1. 商品の location_code を読み込む  
2. Location マスタに存在するか確認  
3. 存在しない場合 → エラーとしてスキップ  
4. Product.location_code に紐づけて保存

このとき、ソート順は以下の2つの方法がある：

### ① Product には sort_order を持たせず、JOINで参照する（推奨）

メリット：
- 倉庫の棚順変更時に Product の更新が不要

### ② Product に sort_order をコピーして保存

メリット：
- ピッキングリスト作成のクエリが軽くなる  
デメリット：
- 倉庫レイアウト変更時のメンテ増

**初期バージョンは①を採用することを推奨。**

---

# 7. CSV との連動仕様

CSV の `location_code` は Location.code と一致する必要がある。

### チェック内容：

- 空欄でないこと  
- 先頭/後尾の空白 trim  
- 大文字・小文字の揺れを正規化（例：`a-01-05` → `A-01-05`）  
- Location マスタに存在するか確認する  

---

# 8. 運用フロー（棚番変更時）

倉庫の棚変更（例：棚を増設 / レイアウト変更）が発生した場合：

1. Location マスタの display_code を書き換える  
2. sort_order を棚順に合わせて再設定する  
3. 既存商品（Product）には影響なし  
4. ピッキングリストは **自動で新しい順序に反映**される  

→ これにより “DB再構築が不要” となり運用が非常に楽になる。

---

# 9. 将来的な拡張案

- display_code 自動生成テンプレート（例：`"{zone}-{rack:02}-{level}"`）
- ロケーションマップ（倉庫内の棚配置図の表示）
- QR コード付き棚番ラベルとの連動
- zone/aisle/rack/level/bin の絞り込み UI
- 多フロア倉庫対応（floor フィールド追加）

---

# 10. 関連ドキュメント

- `project_requirements.md`（要件定義）
- `csv-format.md`（CSV インポート仕様）
- `api-design.md`（API 仕様）
- `data-model.md`（詳細データモデル）
