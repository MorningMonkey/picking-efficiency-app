# CSV インポート仕様書（Draft）

本ドキュメントでは、本社システムから受領する **受注データ CSV** の仕様を定義する。  
主に **Order（受注）** および **OrderItem（受注明細）** を生成するためのデータフォーマットとなる。

---

## 1. 目的とスコープ

- ピッキングリスト生成のために必要な最低限の注文情報を CSV で取り込むための仕様を定義する。
- Phase1 では **単一パターンの CSV** を採用し、Phase2 以降は倉庫ごとのフォーマット差異に対応できるよう、設定による切替を想定する。
- マスタ連携（Customer / Product）は **CSV 内の項目から自動生成**、または **既存マスタと照合** のどちらも可能な構造とする。

---

## 2. CSV ファイルの前提

| 項目           | 内容                                       |
| -------------- | ------------------------------------------ |
| 文字コード     | UTF-8（BOM 無し）                          |
| 区切り文字     | カンマ (`,`)                               |
| ヘッダ行       | あり（必須）                               |
| 行順の意味     | 任意（OrderItem.order_line_no により制御） |
| バッチ単位     | 1 CSV = 複数 Order を含んでよい            |
| ファイル拡張子 | `.csv`                                     |

---

## 3. 必須カラム（Phase1 初期案）

CSV に**必ず存在し、アプリ側で使用する列**。  
機械処理しやすいよう **snake_case（英数字）** で統一する。

| カラム名          | 型      | 日本語ラベル         | 説明 / 用途                                                     |
| ----------------- | ------- | -------------------- | --------------------------------------------------------------- |
| `order_number`    | string  | 受注番号             | 注文の識別子。Order の主キーとなる（基幹の値をそのまま使用）。  |
| `order_line_no`   | integer | 行番号               | 同一受注内での明細番号。1,2,3,...。ユニークキー構成に含まれる。 |
| `product_barcode` | string  | 商品バーコード       | Product 判定に使用。JAN/GS1 を含むため **文字列扱い**。         |
| `quantity`        | integer | 数量                 | 受注明細数量＝ピック予定数量。                                  |
| `location_code`   | string  | 棚番（ロケーション） | ピッキング時のルート指示に使用。Location マスタと紐づく。       |

---

## 4. 任意カラム（Phase1では未使用だが拡張しやすい）

Phase2 以降の柔軟性を考慮して、あらかじめ列を認識可能にする。

| カラム名        | 型     | 日本語ラベル | 用途                          |
| --------------- | ------ | ------------ | ----------------------------- |
| `customer_code` | string | 顧客コード   | Customer マスタと紐づくキー。 |
| `customer_name` | string | 顧客名       | UI 表示やデバッグに便利。     |
| `product_code`  | string | 製品コード   | Product マスタの内部コード。  |
| `product_name`  | string | 商品名       | UI 表示やテストに有用。       |
| `order_date`    | date   | 受注日       | 日付順の分析や抽出で利用。    |
| `remarks`       | string | 備考         | 特記事項。任意のテキスト。    |

---

## 5. CSV のサンプル（Phase1 基本形）

```csv
customer_code,customer_name,order_number,order_line_no,order_date,product_code,product_name,product_barcode,quantity,location_code
C0001,山田 花子,20241101001,1,2024-11-01,P-1001,サンプル商品A,4901234567890,3,A-01-05
C0001,佐藤 香織,20241101001,2,2024-11-01,P-1002,サンプル商品B,4901234567891,2,A-02-03
C0002,田中 太郎,20241101002,1,2024-11-01,P-1200,サンプル商品C,4901234500001,1,B-01-01

```

---

## 6. データ型とバリデーションルール

### 6-1. order_number

必須

型：string

空白禁止

重複可（別 CSV に同じ注文が含まれる運用は不可とする）

### 6-2. order_line_no

必須

型：integer（自然数）

同一 order_number 内でユニーク

### 6-3. product_barcode

必須

型：string

先頭ゼロがあるため、数値変換禁止

### 6-4. quantity

必須

型：integer

quantity > 0 必須

上限は任意（倉庫ごとに設定）

### 6-5. location_code

必須

型：string

Location マスタに存在するコードであること（存在しない場合はエラー）

大文字・小文字の扱いは「大文字に正規化」などルールを決める

----

## 7. エラー処理方針

### 7-1. 行単位のエラー処理

以下のようなケース：

quantity <= 0

product_barcode が空

location_code がマスタに存在しない

数値列に文字列が含まれている

→ その行だけスキップし、エラーログに記録。

### 7-2. ファイル単位のエラー処理

- 必須ヘッダが欠落

- CSV 形式の破損

- 行ごとのカラム数が不一致

 → CSV 全体の取り込みを中断。

### 7-3. エラーログ（import_logs）

- 記録内容：

- ファイル名

- 行番号

- エラー内容

- 処理日時

- 操作ユーザー名

---

### 8. Phase2 以降の拡張案

- カラムの「使用／未使用」を Django admin で設定可能にする

- 顧客マスタ / 製品マスタの別 CSV 読み取り

- Location（棚番）のテンプレート生成ルールを設定化

- JSON / API 連携に切り替え可能な構造を設計する

---

### 9. 関連ドキュメント

- project_requirements.md（要件定義）

- location-design.md（棚番・ロケーション設計）

- api-design.md（スキャンAPI仕様）